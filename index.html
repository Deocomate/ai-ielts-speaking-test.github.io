<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Speaking Practice with AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html,
        body {
            height: 100%;
            overflow: hidden;
            /* Prevent scrolling on the body */
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom styles for chat bubbles */
        .chat-bubble {
            max-width: 85%;
            padding: 12px 18px;
            border-radius: 20px;
            margin-bottom: 12px;
            word-wrap: break-word;
        }

        .chat-bubble-ai {
            background-color: #f1f5f9;
            /* slate-100 */
            color: #1e293b;
            /* slate-800 */
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .chat-bubble-user {
            background-color: #2563eb;
            /* blue-600 */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        /* Blinking dot animation */
        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        .blinking-dot {
            animation: blink 1.4s linear infinite;
        }

        /* Simple markdown parsing for evaluation */
        #evaluationResult h3 {
            font-size: 1.125rem;
            /* text-lg */
            font-weight: 600;
            /* font-semibold */
            margin-top: 1.5rem;
            /* mt-6 */
            margin-bottom: 0.5rem;
            /* mb-2 */
            border-bottom: 1px solid #e2e8f0;
            /* border-b border-slate-200 */
            padding-bottom: 0.5rem;
            /* pb-2 */
            color: #1e293b;
            /* slate-800 */
        }

        #evaluationResult p {
            margin-bottom: 1rem;
            /* mb-4 */
            line-height: 1.6;
        }

        #evaluationResult ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            /* pl-6 */
            margin-bottom: 1rem;
            /* mb-4 */
        }

        #evaluationResult strong {
            font-weight: 600;
            /* font-semibold */
            color: #0f172a;
            /* slate-900 */
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800">

    <div class="bg-white p-4 sm:p-8 rounded-2xl shadow-2xl w-full max-w-3xl mx-auto flex flex-col h-full my-auto">
        <header class="text-center border-b pb-4 mb-4 flex-shrink-0">
            <h1 class="text-2xl sm:text-3xl font-bold text-slate-900">IELTS Speaking Practice with AI</h1>
            <p class="text-sm text-slate-500 mt-1">Powered by Google Gemini</p>
        </header>

        <div id="apiKeySection" class="w-full max-w-md mx-auto my-auto flex flex-col justify-center">
            <h2 class="text-lg font-semibold text-center mb-4">Nhập API Key của bạn</h2>
            <p class="text-center text-sm text-slate-600 mb-4">
                Khóa của bạn được lưu trữ cục bộ trong trình duyệt.
                Lấy khóa của bạn từ <a href="https://aistudio.google.com/app/apikey" target="_blank"
                    class="text-blue-600 hover:underline">Google AI Studio</a>.
            </p>
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="password" id="apiKeyInput"
                    class="flex-grow p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition"
                    placeholder="Nhập Google Gemini API Key của bạn">
                <button id="saveApiKeyBtn"
                    class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition shadow-sm">Lưu
                    & Bắt đầu</button>
            </div>
        </div>

        <main id="appSection" class="hidden flex-grow flex flex-col overflow-hidden">
            <div id="conversationLog"
                class="flex-grow overflow-y-auto p-4 space-y-4 flex flex-col bg-slate-50 rounded-lg mb-4">
                <!-- Chat messages will appear here -->
            </div>

            <div id="guidanceAlert"
                class="hidden bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-4 rounded-md" role="alert">
                <p class="font-bold">Sẵn sàng bắt đầu!</p>
                <p id="guidanceText">Nhấn "Bắt đầu nghe" để AI đọc câu hỏi đầu tiên.</p>
            </div>

            <div id="statusIndicator"
                class="text-center p-3 h-16 flex items-center justify-center rounded-lg bg-slate-100 transition-all duration-300 flex-shrink-0">
                <p id="statusText" class="text-slate-600 font-medium">Nhấn "Bắt đầu Thi" để khởi động.</p>
            </div>

            <div id="controls" class="mt-4 flex items-center justify-center gap-4 flex-shrink-0">
                <button id="controlButton"
                    class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition shadow-sm w-full max-w-xs">
                    Bắt đầu Thi
                </button>
                <button id="stopTestBtn"
                    class="hidden bg-red-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-700 transition shadow-sm">
                    Dừng Thi
                </button>
            </div>
            <div class="text-center mt-4 flex-shrink-0">
                <button id="changeApiBtn" class="text-sm text-slate-500 hover:text-blue-600">Đổi Key</button>
            </div>
        </main>

        <div id="evaluationSection" class="hidden flex-grow flex flex-col overflow-hidden">
            <h2 class="text-2xl font-bold text-center mb-4 text-slate-900 flex-shrink-0">Đánh giá Bài thi Nói IELTS</h2>
            <div id="evaluationResult" class="flex-grow overflow-y-auto p-4 bg-slate-50 rounded-lg">
                <!-- Evaluation will appear here -->
            </div>
            <div class="text-center mt-6 flex-shrink-0">
                <button id="restartTestBtn"
                    class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition shadow-sm">
                    Bắt đầu Bài thi Mới
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM ELEMENTS ---
        const apiKeySection = document.getElementById('apiKeySection');
        const appSection = document.getElementById('appSection');
        const evaluationSection = document.getElementById('evaluationSection');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
        const changeApiBtn = document.getElementById('changeApiBtn');
        const conversationLog = document.getElementById('conversationLog');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const controlButton = document.getElementById('controlButton');
        const stopTestBtn = document.getElementById('stopTestBtn');
        const evaluationResult = document.getElementById('evaluationResult');
        const restartTestBtn = document.getElementById('restartTestBtn');
        const guidanceAlert = document.getElementById('guidanceAlert');
        const guidanceText = document.getElementById('guidanceText');

        // --- STATE MANAGEMENT ---
        let geminiApiKey = '';
        let conversationHistory = [];
        let isTestRunning = false;
        let isListening = false;
        let isAISpeaking = false;
        let isFirstMessage = false; // New state to handle first interaction
        let mediaRecorder;
        let audioChunks = [];
        let preparationTimer;
        let voices = [];

        // --- CONSTANTS ---
        const API_URL = (model) => `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=`;
        const SYSTEM_INSTRUCTION = {
            role: "user",
            parts: [{
                text: `YOU ARE AN IELTS SPEAKING EXAMINER

**Role and Objective:**
You are a professional and experienced IELTS speaking examiner. Your task is to conduct a full IELTS speaking test (Parts 1, 2, and 3) with me, the test-taker. The goal is to accurately simulate a real exam and then provide detailed, constructive feedback.

**Procedure and Guidelines:**

**Crucial Rule: You must operate in a turn-by-turn manner. Ask only one question (or provide one instruction, like the Part 2 cue card), and then WAIT for my response. Do not provide the next question or part of the test until after I have responded.**

1.  **Starting the Test:**
    * Greet me and perform the opening procedures like a real examiner (e.g., "Good morning, my name is Gemini. Can you tell me your full name, please? And what can I call you?").
    * Briefly introduce the 3-part structure of the test.

2.  **Conducting Part 1 (4-5 minutes):**
    * Ask me a series of questions on familiar topics such as hometown, family, work/studies, and hobbies.

3.  **Conducting Part 2 (3-4 minutes):**
    * Introduce Part 2 by saying "Now, I'm going to give you a topic...".
    * Give me a clear cue card.
    * Clearly state that I have 1 minute to prepare and can make notes.
    * Ask me to start speaking and listen for 1-2 minutes.
    * After I finish, ask 1-2 brief follow-up questions related to the topic.

4.  **Conducting Part 3 (4-5 minutes):**
    * Transition to Part 3 by asking more abstract, discussion-based questions related to the Part 2 topic.

5.  **Ending and Evaluating:**
    * After completing Part 3, clearly announce the end of the test ("That is the end of the speaking test.").
    * **Important:** Immediately after this sentence, switch to the role of an expert evaluator. Provide a detailed analysis of my performance using the following exact format. Do not add any conversational text before or after this structure.
    
    ### Overall Band Score: [Provide a single number, e.g., 7.5]
    
    ### Fluency and Coherence
    [Provide your detailed analysis for this criterion here. Use bullet points for specific examples.]
    
    ### Lexical Resource
    [Provide your detailed analysis for this criterion here. Use bullet points for specific examples.]
    
    ### Grammatical Range and Accuracy
    [Provide your detailed analysis for this criterion here. Use bullet points for specific examples.]
    
    ### Pronunciation
    [Provide your detailed analysis for this criterion here. Use bullet points for specific examples.]
    
    ### Actionable Advice for Improvement
    [Provide your detailed analysis for this criterion here. Use bullet points for specific suggestions.]

Now, let's begin. I am ready for the test.`
            }]
        };

        // --- TEXT-TO-SPEECH & AUDIO ---
        function initVoices() {
            return new Promise((resolve) => {
                voices = window.speechSynthesis.getVoices();
                if (voices.length > 0) {
                    resolve(voices);
                } else {
                    window.speechSynthesis.onvoiceschanged = () => {
                        voices = window.speechSynthesis.getVoices();
                        resolve(voices);
                    };
                }
            });
        }

        function speakText(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.95;
            utterance.pitch = 1;
            utterance.volume = 1;

            const englishVoice = voices.find(voice =>
                voice.lang.includes('en') &&
                (voice.name.includes('Google') || voice.name.includes('Daniel') || voice.name.includes('Male'))
            ) || voices.find(voice => voice.lang.includes('en'));

            if (englishVoice) utterance.voice = englishVoice;

            utterance.onstart = () => {
                isAISpeaking = true;
                updateStatus('AI đang nói...', true);
            };

            utterance.onend = () => {
                isAISpeaking = false;
                if (isTestRunning) {
                    if (text.toLowerCase().includes("i'm going to give you a topic")) {
                        startPart2Preparation();
                    } else {
                        startListening();
                    }
                }
            };

            utterance.onerror = (e) => {
                console.error("Speech synthesis error:", e);
                isAISpeaking = false;
                if (isTestRunning) {
                    updateStatus('Lỗi phát âm. Nhấn "Bắt đầu trả lời" để tiếp tục.', false);
                    updateControlButtonForManualProgress(text);
                }
            };

            window.speechSynthesis.speak(utterance);
        }

        // --- INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', async () => {
            await initVoices();
            geminiApiKey = localStorage.getItem('geminiApiKey');
            if (geminiApiKey) {
                apiKeyInput.value = geminiApiKey;
                showApp();
            } else {
                showApiKeySection();
            }

            saveApiKeyBtn.addEventListener('click', saveApiKey);
            changeApiBtn.addEventListener('click', () => {
                if (isTestRunning && !window.confirm("Bạn có chắc muốn kết thúc bài thi hiện tại và đổi API key không?")) return;
                resetApp();
                showApiKeySection();
            });
            controlButton.addEventListener('click', handleControlButtonClick);
            stopTestBtn.addEventListener('click', () => {
                if (window.confirm("Bạn có chắc chắn muốn dừng bài thi ngay lập tức không?")) {
                    resetApp();
                }
            });
            restartTestBtn.addEventListener('click', () => {
                resetApp();
                showApp();
            });
        });

        // --- UI MANAGEMENT ---
        function showApiKeySection() {
            apiKeySection.classList.remove('hidden');
            apiKeySection.classList.add('flex');
            appSection.classList.add('hidden');
            appSection.classList.remove('flex');
            evaluationSection.classList.add('hidden');
        }

        function showApp() {
            apiKeySection.classList.add('hidden');
            apiKeySection.classList.remove('flex');
            appSection.classList.remove('hidden');
            appSection.classList.add('flex');
            evaluationSection.classList.add('hidden');
        }

        function showEvaluation() {
            appSection.classList.add('hidden');
            appSection.classList.remove('flex');
            evaluationSection.classList.remove('hidden');
            evaluationSection.classList.add('flex');
        }

        function updateStatus(text, isBlinking = false) {
            statusText.innerHTML = text;
            if (isBlinking) {
                statusIndicator.classList.add('bg-yellow-100');
                statusText.innerHTML += ' <span class="blinking-dot">●</span>';
            } else {
                statusIndicator.classList.remove('bg-yellow-100');
            }
        }

        function showGuidanceAlert(text) {
            guidanceText.innerText = text;
            guidanceAlert.classList.remove('hidden');
        }

        function hideGuidanceAlert() {
            guidanceAlert.classList.add('hidden');
        }

        function addMessageToLog(text, sender) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('chat-bubble', sender === 'ai' ? 'chat-bubble-ai' : 'chat-bubble-user');

            if (sender === 'ai') {
                const textDiv = document.createElement('div');
                textDiv.innerText = text;

                const replayButton = document.createElement('button');
                replayButton.innerHTML = '🔊 Nghe lại';
                replayButton.className = 'text-xs bg-slate-200 hover:bg-slate-300 p-1 mt-2 rounded';
                replayButton.onclick = () => speakText(text);

                messageWrapper.appendChild(textDiv);
                messageWrapper.appendChild(replayButton);
            } else {
                messageWrapper.innerText = text;
            }

            conversationLog.appendChild(messageWrapper);
            conversationLog.scrollTop = conversationLog.scrollHeight;
        }

        function updateControlButtonForManualProgress(text) {
            controlButton.disabled = false;
            controlButton.innerText = 'Bắt đầu trả lời';
            controlButton.onclick = () => {
                controlButton.onclick = handleControlButtonClick; // Restore
                if (text.toLowerCase().includes("i'm going to give you a topic")) {
                    startPart2Preparation();
                } else {
                    startListening();
                }
            };
        }

        // --- CORE LOGIC ---
        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            if (key) {
                geminiApiKey = key;
                localStorage.setItem('geminiApiKey', key);
                showApp();
            } else {
                alert('Vui lòng nhập một API key hợp lệ.');
            }
        }

        async function handleControlButtonClick() {
            if (!isTestRunning) {
                await startTest();
            } else if (isListening) {
                stopListening();
            }
        }

        async function startTest() {
            isTestRunning = true;
            isFirstMessage = true; // Set flag for the first message
            controlButton.disabled = true;
            controlButton.innerText = 'Bài thi đang diễn ra...';
            stopTestBtn.classList.remove('hidden');
            updateStatus('Đang khởi tạo bài thi...', true);

            conversationHistory = [SYSTEM_INSTRUCTION];

            try {
                const firstUserMessage = { role: "user", parts: [{ text: "Please begin the test." }] };
                conversationHistory.push(firstUserMessage);

                const aiResponse = await callGeminiApi(conversationHistory, 'gemini-1.5-flash-latest');
                await handleAIResponse(aiResponse);
            } catch (error) {
                console.error("Lỗi khi bắt đầu bài thi:", error);
                alert("Không thể bắt đầu bài thi. Kiểm tra API key và console để biết lỗi.");
                resetApp();
            }
        }

        async function handleAIResponse(text) {
            addMessageToLog(text, 'ai');
            conversationHistory.push({ role: "model", parts: [{ text }] });

            if (text.toLowerCase().includes("that is the end of the speaking test")) {
                await endTestAndEvaluate(text);
                return;
            }

            // Special handling for the first message on mobile
            if (isFirstMessage && isTestRunning) {
                isFirstMessage = false;
                showGuidanceAlert('Nhấn "Bắt đầu nghe" để AI đọc câu hỏi đầu tiên.');
                updateStatus('Sẵn sàng cho câu hỏi đầu tiên.', false);
                controlButton.innerText = 'Bắt đầu nghe';
                controlButton.disabled = false;
                controlButton.onclick = () => {
                    hideGuidanceAlert();
                    controlButton.onclick = handleControlButtonClick; // Restore original handler
                    speakText(text);
                };
            } else {
                // For subsequent messages, speak automatically
                speakText(text);
            }
        }

        function startPart2Preparation() {
            window.speechSynthesis.cancel();
            let timeLeft = 60;
            controlButton.disabled = true;
            controlButton.innerText = 'Đang chuẩn bị...';
            updateStatus(`Thời gian chuẩn bị: ${timeLeft} giây`);

            preparationTimer = setInterval(() => {
                timeLeft--;
                updateStatus(`Thời gian chuẩn bị: ${timeLeft} giây`);
                if (timeLeft <= 0) {
                    clearInterval(preparationTimer);
                    const endPrepText = "Your preparation time is over. Please start speaking now.";
                    addMessageToLog(endPrepText, 'ai');
                    speakText(endPrepText);
                }
            }, 1000);
        }

        function startListening() {
            if (isAISpeaking) return;

            isListening = true;
            controlButton.disabled = false;
            controlButton.innerText = 'Dừng Ghi âm';
            controlButton.onclick = handleControlButtonClick;
            updateStatus('Đang nghe... Mời bạn nói.', true);

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                    mediaRecorder.onstop = processAudio;
                    mediaRecorder.start();
                }).catch(err => {
                    console.error("Lỗi truy cập micro:", err);
                    alert("Không thể truy cập micro. Vui lòng cấp quyền và thử lại.");
                    resetApp();
                });
        }

        function stopListening() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                isListening = false;
                controlButton.disabled = true;
                controlButton.innerText = 'Đang xử lý...';
                updateStatus('Đang xử lý câu trả lời của bạn...', true);
            }
        }

        async function processAudio() {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = async () => {
                const base64Audio = reader.result.split(',')[1];
                const userMessage = {
                    role: "user",
                    parts: [
                        { inline_data: { mime_type: "audio/webm", data: base64Audio } },
                        { text: "This is my audio response. Transcribe it, then provide the next question or part of the test." }
                    ]
                };

                // First, get the transcription to display it
                try {
                    const transcriptionResponse = await callGeminiApi([...conversationHistory, userMessage], 'gemini-1.5-flash-latest');
                    addMessageToLog(`Bạn đã nói: "${transcriptionResponse}"`, 'user');
                    conversationHistory.push({ role: "user", parts: [{ text: transcriptionResponse }] });

                    // Then, get the AI's next question
                    updateStatus('AI đang suy nghĩ...', true);
                    const aiResponse = await callGeminiApi(conversationHistory, 'gemini-1.5-flash-latest');
                    await handleAIResponse(aiResponse);

                } catch (error) {
                    console.error("Lỗi sau khi gửi âm thanh:", error);
                    alert("Đã xảy ra lỗi khi xử lý câu trả lời của bạn. Vui lòng kiểm tra console.");
                    resetApp();
                }
            };
        }

        async function endTestAndEvaluate(finalText) {
            window.speechSynthesis.cancel();
            updateStatus('Bài thi kết thúc. Đang tạo phản hồi cho bạn...', true);
            isTestRunning = false;
            controlButton.style.display = 'none';
            stopTestBtn.classList.add('hidden');

            // The evaluation is already part of the final text from the AI
            displayEvaluation(finalText);
        }

        function displayEvaluation(feedbackText) {
            let html = '';
            // Extract the score first
            const scoreMatch = feedbackText.match(/### Overall Band Score: ([\d.]+)/);
            if (scoreMatch && scoreMatch[1]) {
                const score = scoreMatch[1];
                html += `<div class="text-center mb-6 p-4 bg-white rounded-lg shadow">
                            <p class="text-base font-medium text-slate-600">Dự kiến Band điểm Speaking</p>
                            <p class="text-6xl font-bold text-blue-600 my-2">${score}</p>
                         </div>`;
            }

            // Process the rest of the feedback
            const restOfFeedback = feedbackText.substring(feedbackText.indexOf("### Fluency and Coherence"));
            let processedFeedback = restOfFeedback
                .replace(/### (.*?)(?:\r\n|\r|\n)/g, '<h3>$1</h3>')
                .replace(/\* (.*?)(?:\r\n|\r|\n)/g, '<li>$1</li>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Wrap list items in <ul> tags correctly
            processedFeedback = processedFeedback.replace(/(<li>.*?<\/li>)/gs, '<ul>$1</ul>').replace(/<\/ul>\s*<ul>/g, '');

            html += processedFeedback;

            evaluationResult.innerHTML = html;
            showEvaluation();
        }

        function resetApp() {
            window.speechSynthesis.cancel();
            hideGuidanceAlert();
            isTestRunning = false;
            isListening = false;
            isAISpeaking = false;
            isFirstMessage = false;
            clearInterval(preparationTimer);
            if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();

            conversationHistory = [];
            conversationLog.innerHTML = '';
            controlButton.innerText = 'Bắt đầu Thi';
            controlButton.disabled = false;
            controlButton.style.display = 'block';
            controlButton.onclick = handleControlButtonClick;
            stopTestBtn.classList.add('hidden');
            updateStatus('Nhấn "Bắt đầu Thi" để khởi động.');
        }

        // --- API & UTILITY FUNCTIONS ---
        async function callGeminiApi(history, model) {
            const response = await fetch(API_URL(model) + geminiApiKey, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: history })
            });
            if (!response.ok) {
                const errorBody = await response.json();
                console.error("Lỗi API:", errorBody);
                throw new Error(`Yêu cầu API thất bại với trạng thái ${response.status}: ${errorBody.error.message}`);
            }
            const data = await response.json();
            if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text) {
                return data.candidates[0].content.parts[0].text;
            }
            // Handle cases where the response might be empty or in a different format
            if (data.candidates && data.candidates[0].finishReason === "STOP") {
                // This can happen if the model just needs to listen. We can return an empty string.
                return "";
            }
            console.error("Invalid API response format:", data);
            throw new Error("Phản hồi API không hợp lệ hoặc trống.");
        }
    </script>
</body>

</html>